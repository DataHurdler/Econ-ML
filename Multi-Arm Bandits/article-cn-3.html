<!doctype html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/default.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">
<link rel="stylesheet" href="file:////Users/zijunluo/.vscode/extensions/goessner.mdmath-2.7.4/themes/default/style.css">

</head>
<body class="markdown-body">
<h1 dir="auto" id="%E9%9A%8F%E6%9C%BA%E5%AF%B9%E7%85%A7%E8%AF%95%E9%AA%8C%E7%9A%84%E8%B4%9D%E5%8F%B6%E6%96%AF%E6%96%B9%E6%B3%953upper-confidence-bound">随机对照试验的贝叶斯方法（3）：Upper Confidence Bound</h1>
<p dir="auto"><strong>作者：</strong> <em>罗子俊</em></p>
<p dir="auto">我们在前面两篇文章里介绍了Epsilon Greedy和Optimistic Initial Values两个算法：</p>
<ul dir="auto">
<li dir="auto">随机对照试验的贝叶斯方法（1）：Epsilon Greedy</li>
<li dir="auto">随机对照试验的贝叶斯方法（2）：Optimistic Initial Values</li>
</ul>
<p dir="auto">今天，我们继续介绍下一个算法，那就是置信上限（Upper Confidence Bound，UCB）。置信上限算法的数学细节在这里我就不作详细介绍了，反正有那么个不同的公式。但是这个方法的直觉和使用方法还是比较简单的。首先我们来回顾一下Epsilon Greedy和Optimistic Initial Values这两个算法。这两个算法在实现当中有一个相同的步骤：根据之前的结果来计算预期胜率，然后选择预期胜率最高的老虎机。这也是为什么这两个算法都被看作是“贪婪”的原因。现在的问题是，我们有没有办法做得比“贪婪”更好。答案是肯定的。因为预期胜率都是基于概率基础上的，而统计学知识告诉我们，如果我们选择一个老虎机的次数越多，我们对预期胜率会更有信心（confidence），因为当一个老虎机选择次数为无穷大时，预期胜率将收敛到真实胜率。那么，那些不经常被选中的老虎机呢？</p>
<p dir="auto">置信上限算法要解决的就是这么一个问题。简单来说，置信算法在选择“最优”的时候并不仅仅依赖预期胜率。我们还应该给每个胜率一点额外的“奖励”：如果一个老虎机被选择的次数很多，那么这个奖励应该很小。但如果一个老虎机被选择次数很少，那么它就应该得到一个大大的奖励。就如我们前面说的，一个经常被选中的老虎机，它的预期胜率将会很接近真实胜率。可是一个不经常被选中的老虎机，它有可能一支“潜力股”。</p>
<p dir="auto">在这篇文章里，我们所使用的“奖励”函数来自于论文<a href="https://homes.di.unimi.it/~cesabian/Pubblicazioni/ml-02.pdf">Finite-time Analysis of the Multiarmed Bandit Problem</a>。这篇论文的作者构造了一个被称为<code>UCB1</code>的函数：</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>b</mi><mi>j</mi></msub><mo>=</mo><msqrt><mfrac><mrow><mn>2</mn><mi>log</mi><mo>⁡</mo><mi>N</mi></mrow><msub><mi>n</mi><mi>j</mi></msub></mfrac></msqrt></mrow><annotation encoding="application/x-tex">b_j=\sqrt{\frac{2\log{N}}{n_j}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.04em;vertical-align:-1.2064590000000002em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8335409999999999em;"><span class="svg-align" style="top:-5em;"><span class="pstrut" style="height:5em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.793541em;"><span class="pstrut" style="height:5em;"></span><span class="hide-tail" style="min-width:1.02em;height:3.08em;"><svg width='400em' height='3.08em' viewBox='0 0 400000 3240' preserveAspectRatio='xMinYMin slice'><path d='M473,2793
c339.3,-1799.3,509.3,-2700,510,-2702 l0 -0
c3.3,-7.3,9.3,-11,18,-11 H400000v40H1017.7
s-90.5,478,-276.2,1466c-185.7,988,-279.5,1483,-281.5,1485c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2c0,-1.3,-5.3,-32,-16,-92c-50.7,-293.3,-119.7,-693.3,-207,-1200
c0,-1.3,-5.3,8.7,-16,30c-10.7,21.3,-21.3,42.7,-32,64s-16,33,-16,33s-26,-26,-26,-26
s76,-153,76,-153s77,-151,77,-151c0.7,0.7,35.7,202,105,604c67.3,400.7,102,602.7,104,
606zM1001 80h400000v40H1017.7z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2064590000000002em;"><span></span></span></span></span></span></span></span></span></span></eqn></section></math>
<p dir="auto">其中 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></eq> 是计算奖励时访客的总数，<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">n_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></eq> 则是老虎机 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></eq> 被选中的次数。预期胜率加上 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">b_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></eq> 就是老虎机 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></eq> 在第 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span></eq> 个访客时的置信上限（Upper Confidence Bound）：</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>UCB1</mtext><mi>j</mi></msub><mo>=</mo><msub><mover accent="true"><mi>x</mi><mo>ˉ</mo></mover><msub><mi>n</mi><mi>j</mi></msub></msub><mo>+</mo><msub><mi>b</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\text{UCB1}_j=\bar{x}_{n_j}+b_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord text"><span class="mord">UCB1</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.93065em;vertical-align:-0.34731999999999996em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.56778em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34731999999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span></eqn></section></math>
<p dir="auto">UCB1的伪代码如下：</p>
<pre><code dir="auto"><code><div>loop:
    Update UCB1 values
    j = argmax(UCB1 values)
    x = reward (1 or 0) from playing bandit j
    bandit[j].update_mean(x)
</div></code></code></pre>
<p dir="auto">跟前面一样，我们把UCB1增加到<code>BayesianAB</code>类当中：</p>
<pre><code class="code-line language-python" dir="auto"><div>  <span class="hljs-comment">####################</span>
  <span class="hljs-comment"># upper confidence bound (UCB1)</span>
  <span class="hljs-keyword">def</span> <span class="hljs-title function_">ucb1</span>(<span class="hljs-params">
      self,
      c = <span class="hljs-number">1</span>,
  </span>) -&gt; <span class="hljs-built_in">list</span>:

    self.history.append(self.prob_win.copy())
    bandit_count = [<span class="hljs-number">0.0001</span>] * <span class="hljs-built_in">len</span>(self.prob_win)
    <span class="hljs-comment"># bound = [0] * len(self.prob_win)</span>

    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, N):
      bound = self.prob_win + c * np.sqrt(<span class="hljs-number">2</span> * np.log(k) / bandit_count)
      <span class="hljs-comment"># find index of the largest value in bound</span>
      i = np.argmax(bound)

      self.update(i, k)

      <span class="hljs-keyword">if</span> bandit_count[i] &lt; <span class="hljs-number">1</span>:
        bandit_count[i] = <span class="hljs-number">0</span>
      bandit_count[i] += <span class="hljs-number">1</span>

    <span class="hljs-keyword">return</span> self.history
</div></code></pre>
<p dir="auto">为了保证分母不为0，我把<code>bandit_count</code>初始值设定为<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.0001</mn></mrow><annotation encoding="application/x-tex">0.0001</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0.0001</span></span></span></span></eq>。当一个老虎机被第一次选中后，我在给计数器加1前先把数值换回0。另外一个办法是像Epsilon Greedy那样，把头50个访客随机分配到各个老虎机，然后在第51个再开始用<code>UCB1</code>算法。</p>
<p dir="auto"><code>UCB1</code>算法有一个参数<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span></eq>。当<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span></eq>的值越大，“奖励”更高，算法探索得也就越多。在代码中，<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span></eq>的默认值设置为1。</p>
<p dir="auto">通过执行以下代码，我们可以得到<code>UCB1</code>的结果以及相应的可视化：</p>
<pre><code class="code-line language-python" dir="auto"><div>ucb = BayesianAB(N_bandits)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;The true win rates: <span class="hljs-subst">{ucb.prob_true}</span>&#x27;</span>)
ucb_history = ucb.ucb1()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;The observed win rates: <span class="hljs-subst">{ucb.prob_win}</span>&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Number of times each bandit was played: <span class="hljs-subst">{ucb.count}</span>&#x27;</span>)

<span class="hljs-comment"># plot the entire experiment history</span>
plot_history(history=ucb.history, prob_true=ucb.prob_true)
</div></code></pre>
<p dir="auto">这是其中一个次实验的结果：</p>
<pre><code dir="auto"><code><div>The true win rates: [0.65, 0.12, 0.63, 0.33, 0.75]
The observed win rates: [0.6505, 0.1165, 0.1928, 0.0774, 0.3794]
Number of times each bandit was played: [99470, 77, 103, 67, 282]
</div></code></code></pre>
<p dir="auto"><img src="ucb1.png" alt="UCB1" data-src="ucb1.png"></p>
<p dir="auto">跟Epsilon Greedy一样，在这一个实验中，<code>UCB1</code>并没有成功地在实验结束时找到胜率最高的老虎机。如果我们看一下头100个访客的结果，我们会发现胜率为0.65的那个老虎机在很早就领先了。如果实验跑的时间足够长，<code>UCB1</code>在理论上是可以找到胜率最高的老虎机的。</p>
<p dir="auto"><img src="ucb1_100.png" alt="UCB1 (first 100)" data-src="ucb1_100.png"></p>
<p dir="auto">在下一篇文章，我们将会讨论另外一个我很喜欢的算法，“梯度（Gradient Bandits）”算法。经济学家看到这个算法时，应该都会觉得很亲切。</p>

</body>
</html>