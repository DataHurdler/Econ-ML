# 随机对照试验的贝叶斯方法

# 前言

随机对照试验（RCT）是通过实验来建立因果关系的黄金标准，在新药临床试验或社会科学和经济领域的现场实验中有广泛的应用。在商业特别是电子商务应用中，RCT被称为A/B/N测试。 RCT和A/B/N测试的主要思想非常简单：将许多个体随机分组，然后比较和评估结果，找出哪种治疗效果更好/最好。在RCT中，包括一个接受“安慰剂”的对照组。请注意，安慰剂也应被视为一种治疗方法，并且接受安慰剂的个体并不是“什么都没有得到”。安慰剂没有治疗效果，换句话说，它不是为了治疗疾病或疾病而设计的。但是，安慰剂可能会对接受它的个体产生心理作用从而对病情产生积极影响。认为RCT中接受安慰剂的对照组“效果为零”是错误的。

在本文的其余部分中，我将使用A/B/N测试作为例子，因为我想避免RCT的许多细节。我们会在文章的最后再回到RCT这个题目上。我用“A/B/N”这个说法来包括测试多个版本的情况。如果你只比较两个版本，那么就只是A/B测试了。

当我在2022年面试数据科学家职位时，其中一个面试问题是：我们将在客户网站上运行A/B测试。如何确定我们的实验需要运行多久？当时，我知道如何根据统计学中的假设检验找到最小样本量，因此我用这种方式来回答。但是，我在回答的中途停下来了，因为我忽然发现了以前没有想过的问题：在进行实验之前，我如何知道标准差？标准差是计算样本大小所需的数值之一。我的面试从那开始走下坡路。最后我没有得到那份工作。但是面试官很好心地告诉我应该看看“功效分析（Power Analysis）”。

以下是我所了解到的功效分析。假设你构建了一个电子商务网站。网站有两种不同的配色方案，你想了解哪种配色方案会促进销售量。你可以随机分配访客到网站的两个版本中的一个。你最后的到的数据中有两列：对于每个访问者，你记录了他们看到的版本和他们的消费量。对于 $i\in(A,B)$，我们定义以下数值：

* $\bar{x}_i$：版本 $i$ 的访客预期消费量；
* $n_i$：版本 $i$ 的访客数量；
* $s_i$：版本 $i$ 的访客花费消费的标准偏差。

现在我们可以计算“功效”为
$$t=\frac{\bar{x}_A-\bar{x}_B}{s_p\sqrt{\tfrac{1}{n_A}+\tfrac{1}{n_B}}}$$

其中 $s_p=\sqrt{\frac{(n_A-1)s_A^2+(n_B-1)s_B^2}{n_A+n_B-2}}$ 是合并标准偏差。 "功效" $t$ 遵循 $n_A+n_B-2$ 自由度的 $t$-分布。

假设你知道在你的 A/B 测试中，两个版本的 $s_A=s_B$，我们将其表示为 $s$。为了简单起见，假设你希望 $n_A=n_B$。你可以从上面的功效分析公式中解出 $n$，得到：
$$N=\frac{4t^2s^2}{(\bar{x}_A-\bar{x}_B)^2}$$
其中 $N$ 是总样本量（$n_A+n_B$）。很容易看出，如果

* 两个版本之间的预期差异较小。
* 你想要更好的显著性水平，例如 1% 而不是 5%；
* 标准偏差较大，即花费的美元在个人之间分散得更广泛。

那么你将需要更大的样本量。

但是问题在于：你在实验之前不知道 $\bar{x}_i$ 和 $s_i$ 的值。对于 $\bar{x}_i$，问题不是很大。你所需要的只是期望差异，它可以被指定。例如，假设你的网站当前正在运行版本 A，你知道 $\bar{x}_i=50$。而你所关心的只是版本 B 能否将预期的花费提高到 65 美元。换句话说，$\bar{x}_B-\bar{x}_A=15$。即使如此，你仍然需要知道标准差。如何做？一些人建议你运行一个短暂的试验来估计标准差。但那么，难道 A/B 测试本身不就是一次试验吗？

以下是关于经典A/B测试设计的另一个问题。我成为数据科学家后，到另一家公司工作，我们尝试运行了一个A/B测试。问题在于，根据上述功效分析，实验需要至少运行3个月，但我们没有那么多时间。在1个月后，我们的模型（版本B）表现优于现有模型（版本A）。我们可以宣称我们的模型更好吗？根据经典的A/B测试设计，答案是“不行”，因为我们不应该进行“窥视”，因为这样的显著差异可能是随机因素造成的。

现在考虑一下新药临床试验，这种“不窥视”的规则可能会引发严重的问题。如果一种药物在前500个患者中证明了其有效性，但功效分析告诉你需要在5万名患者身上进行测试，你会怎么做？继续给可能从实际药物中受益的患者使用安慰剂不道德吗？

这两个问题一直困扰着我，直到我了解到贝叶斯方法用于A/B/N测试。下面是它的工作原理。与预先确定样本量不同，A/B测试在实时中部署。继续我们之前的例子，一个访问者在第一次访问时会被随机分配到网站的一个版本。在实践中，最好确保每个版本最初都得到一些访问者，例如对于50个访问者，每个版本都有相等的概率被分配。但从那里开始，收到更高购买价值的版本应该获得更多的访问者。这并不意味着另一个版本被抛弃。在这里，我们面临着探索和利用的权衡。

## 探索和利用的权衡

在简单概括中，探索-开发权衡显示了一个悖论：为了找到最佳版本，你需要探索，这意味着随着你尝试不同版本的时间越长，探索的结果必然会变得更好。然而，为了最大化总体回报，一旦找到最佳版本，你希望坚持使用它，也就是开发。这意味着，随着你尝试不同版本的时间越长，开发的结果必然会变得更糟，因为只有一个最佳版本。

如何处理探索-开发权衡构成了算法之间的核心差异。一些算法，如“贪婪算法”家族的变体，真正专注于开发。缺点是这种算法很容易“陷入”第二最佳版本，正如在我们讨论“贪婪算法（Epsilon Greedy）”算法时稍后将展示的那样。其他算法，如“乐观初始值”，最初专注于探索。

如果你正在阅读这篇文章，是因为你认为它可能有助于你的研究项目，那么你不会陌生于探索-利用平衡的问题。我记得在我毕业后不久，我曾与一位研究生时期的教授进行了一次对话。我问他是否应该放弃那些我认为不会被发表在好期刊上的项目。他回答说：但你怎么知道呢？他有道理：我的教授从未发表过他的博士论文中的任何一章。只有在他探索新的研究领域之后，他才获得了成功。然而，大约15年后，一篇与他在博士论文中研究的主题非常相关的论文被发表在了一个顶级期刊上。回想起来，他可能探索得比最优解更多，这可能是他建议我更多地利用的原因。